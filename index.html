<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BASISRENTE Pro 2026</title>
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0">

    <style>
        :root { 
            --ios-bg: #F5F5F7; 
            --ios-card: rgba(255, 255, 255, 0.85); 
            --ios-text: #1D1D1F; 
            --ios-subtext: #86868B; 
            --ios-blue: #0071E3; 
            --ios-green: #34C759;
            --shadow-subtle: 0 8px 30px rgba(0,0,0,0.04);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.08);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            background-color: var(--ios-bg); 
            color: var(--ios-text); 
            -webkit-font-smoothing: antialiased; 
            overflow-x: hidden;
        }

        /* --- Login Overlay --- */
        #auth-overlay { 
            position: fixed; inset: 0; z-index: 9999; 
            background: rgba(245, 245, 247, 0.8); 
            backdrop-filter: blur(50px) saturate(180%); -webkit-backdrop-filter: blur(50px) saturate(180%); 
            display: flex; justify-content: center; align-items: center; 
            padding: 20px; transition: all 0.7s var(--ease-spring);
            opacity: 1; visibility: visible;
        }
        #auth-overlay.hidden-overlay { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.1); filter: blur(20px); }
        
        #main-app { 
            transition: filter 0.7s ease, transform 0.7s var(--ease-spring); 
            filter: blur(20px) grayscale(0.2); transform: scale(0.96); 
            pointer-events: none; user-select: none; height: 100vh; overflow: hidden; 
        }
        #main-app.active-app { 
            filter: blur(0) grayscale(0); transform: scale(1); 
            pointer-events: auto; user-select: auto; height: auto; overflow: visible; 
        }

        .auth-card { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(50px); 
            border-radius: 32px; padding: 48px; width: 100%; max-width: 440px; 
            box-shadow: 0 40px 80px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.5); 
        }

        /* --- Premium Cards --- */
        .ios-card { 
            background-color: var(--ios-card); 
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 24px; 
            box-shadow: var(--shadow-subtle); 
            border: 1px solid rgba(255,255,255,0.6);
            transition: transform 0.5s var(--ease-spring), box-shadow 0.5s ease, border-color 0.3s;
            will-change: transform;
        }
        .ios-card:hover { 
            transform: translateY(-4px) scale(1.005); 
            box-shadow: var(--shadow-hover); 
            border-color: rgba(255,255,255,0.9);
            z-index: 10;
        }

        /* --- Apple Toggle Switch (NEW) --- */
        .toggle-switch {
            appearance: none;
            width: 51px;
            height: 31px;
            background: #E9E9EA;
            border-radius: 99px;
            position: relative;
            cursor: pointer;
            outline: none;
            transition: background 0.3s ease;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.3s var(--ease-spring);
        }
        .toggle-switch:checked {
            background: var(--ios-green);
        }
        .toggle-switch:checked::after {
            transform: translateX(20px);
        }
        .toggle-switch:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- Inputs --- */
        .ios-input-group { 
            background: rgba(239, 239, 244, 0.6); border-radius: 16px; padding: 14px 18px; 
            margin-bottom: 14px; display: flex; align-items: center; 
            transition: all 0.4s var(--ease-spring); border: 1px solid transparent;
        }
        .ios-input-group:hover { background: #FFFFFF; transform: scale(1.01); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .ios-input-group:focus-within { 
            background: #FFFFFF; border-color: var(--ios-blue); 
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.12); transform: scale(1.02);
        }
        .ios-input { 
            background: transparent; border: none; width: 100%; 
            font-size: 16px; font-weight: 500; color: var(--ios-text); 
            outline: none; margin-left: 10px; 
        }
        
        .segmented-control { 
            background: rgba(118, 118, 128, 0.12); border-radius: 14px; padding: 4px; display: flex; 
        }
        .segmented-option { 
            flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 600; 
            border-radius: 11px; cursor: pointer; color: var(--ios-text); transition: all 0.4s var(--ease-spring); 
        }
        .segmented-option.active { 
            background: #FFFFFF; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: scale(1.02);
        }

        .auth-btn { 
            background: linear-gradient(135deg, #0071E3, #0077ED); 
            color: white; width: 100%; padding: 18px; border-radius: 18px; 
            font-weight: 600; font-size: 16px; border: none; cursor: pointer; 
            transition: all 0.4s var(--ease-spring); box-shadow: 0 8px 20px rgba(0, 113, 227, 0.25); 
        }
        .auth-btn:hover { transform: translateY(-2px) scale(1.03); box-shadow: 0 15px 35px rgba(0, 113, 227, 0.35); }
        .auth-btn:active { transform: scale(0.97); }

        .custom-select-container { position: relative; cursor: pointer; z-index: 50; }
        .custom-select-trigger {
            background: rgba(239, 239, 244, 0.6); border-radius: 16px; padding: 14px 18px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 15px; font-weight: 500; transition: all 0.3s var(--ease-spring);
        }
        .custom-select-trigger:hover { background: #FFFFFF; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .custom-select-options {
            position: absolute; top: 120%; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(30px);
            border-radius: 18px; padding: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.5);
            opacity: 0; visibility: hidden; transform: translateY(-15px) scale(0.95);
            transition: all 0.4s var(--ease-spring);
            z-index: 100; max-height: 300px; overflow-y: auto;
        }
        .custom-select-container.open .custom-select-options { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
        .custom-option { padding: 12px 16px; font-size: 14px; border-radius: 12px; transition: 0.1s; display: flex; justify-content: space-between; }
        .custom-option:hover, .custom-option.selected { background: #0071E3; color: white; }

        #logoutBtn { display: none; }
        #global-error-box { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 59, 48, 0.9); backdrop-filter: blur(10px); color: white; padding: 12px 24px; border-radius: 99px; z-index: 10000; box-shadow: 0 10px 30px rgba(255, 59, 48, 0.3); font-size: 14px; font-weight: 600; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        /* Print PDF container styling */
        #print-container { display: none; }
    </style>
</head>
<body class="pb-16 min-h-screen flex flex-col relative selection:bg-blue-100 selection:text-blue-900">

    <!-- Global Error Handler -->
    <div id="global-error-box">
        <span class="material-symbols-rounded align-middle mr-1 text-lg">error</span>
        <span id="global-error-msg" class="align-middle">Ein Fehler ist aufgetreten.</span>
    </div>

    <!-- === AUTH OVERLAY === -->
    <div id="auth-overlay">
        <div class="auth-card">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-50 to-blue-100 text-[#0071E3] rounded-[28px] flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-100/50 border border-white">
                    <span class="material-symbols-rounded text-4xl">lock_open</span>
                </div>
                <h2 class="text-3xl font-bold tracking-tight text-[#1D1D1F] mb-3" id="authTitle">Willkommen</h2>
                <p class="text-[15px] text-[#86868B] leading-relaxed font-medium" id="authSubtitle">
                    Melden Sie sich an, um Zugriff auf den<br>Basisrente-Rechner 2026 zu erhalten.
                </p>
            </div>

            <form id="authForm" class="space-y-4">
                <div id="nameField" class="hidden">
                    <div class="ios-input-group">
                        <span class="material-symbols-rounded text-[#86868B]">person</span>
                        <input type="text" id="regName" class="ios-input" placeholder="Vollständiger Name">
                    </div>
                </div>
                <div class="ios-input-group">
                    <span class="material-symbols-rounded text-[#86868B]">mail</span>
                    <input type="email" id="authEmail" required class="ios-input" placeholder="E-Mail Adresse">
                </div>
                <div id="phoneField" class="hidden">
                    <div class="ios-input-group">
                        <span class="material-symbols-rounded text-[#86868B]">smartphone</span>
                        <input type="tel" id="regPhone" class="ios-input" placeholder="Mobilnummer">
                    </div>
                </div>
                <div class="ios-input-group">
                    <span class="material-symbols-rounded text-[#86868B]">key</span>
                    <input type="password" id="authPass" required class="ios-input" placeholder="Passwort (min. 6 Zeichen)" minlength="6">
                </div>
                <div id="consentField" class="hidden pt-2">
                    <div class="flex items-center gap-3">
                        <!-- Using toggle switch for consent too for consistency -->
                        <input type="checkbox" id="regConsent" class="toggle-switch" style="transform: scale(0.6); margin: 0;">
                        <label for="regConsent" class="text-[11px] text-[#86868B] leading-tight cursor-pointer select-none flex-1">
                            Ich stimme der Verarbeitung meiner Daten gemäß der Datenschutzerklärung zu.
                        </label>
                    </div>
                </div>
                <div id="forgotPasswordContainer" class="text-right pt-1">
                    <a href="#" id="forgotPasswordBtn" class="text-xs text-[#0071E3] font-semibold hover:underline transition-all">Passwort vergessen?</a>
                </div>
                <div id="errorMsg" class="text-red-500 text-xs text-center font-medium hidden bg-red-50 p-3 rounded-xl border border-red-100"></div>
                <div id="successMsg" class="text-green-600 text-xs text-center font-medium hidden bg-green-50 p-3 rounded-xl border border-green-100"></div>
                <button type="submit" class="auth-btn mt-6" id="authBtnLabel">Anmelden</button>
            </form>
            <div class="text-center mt-8">
                <button id="toggleAuthMode" class="text-[#0071E3] text-sm font-semibold hover:text-[#005bb5] transition-colors">
                    Noch kein Konto? Jetzt registrieren
                </button>
            </div>
        </div>
    </div>

    <!-- === MAIN APP === -->
    <div id="main-app">
        <!-- Header -->
        <header class="sticky top-0 z-[90] bg-[#F5F5F7]/85 backdrop-blur-2xl border-b border-[rgba(0,0,0,0.03)]">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div>
                        <h1 class="text-lg font-bold tracking-widest text-[#1D1D1F] uppercase">BASISRENTE</h1>
                        <p class="text-[10px] text-[#86868B] uppercase tracking-wider font-bold mt-0.5">Pro Edition 2026</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="logoutBtn" class="bg-white hover:bg-gray-50 text-[#1D1D1F] border border-gray-200 px-5 py-2.5 rounded-full text-xs font-bold transition-all flex items-center gap-2 shadow-sm hover:shadow-md hover:scale-105">
                        <span class="material-symbols-rounded text-sm">logout</span>
                        <span>Abmelden</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Grid -->
        <main id="calculator-content" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT: Settings -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Personal Data Card -->
                <div class="ios-card p-6 relative" style="z-index: 50;">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-blue-50 text-[#0071E3] flex items-center justify-center shadow-sm">
                            <span class="material-symbols-rounded text-xl">person</span>
                        </div>
                        <h2 class="text-lg font-bold text-[#1D1D1F]">Persönliche Daten</h2>
                    </div>
                    
                    <div class="space-y-5">
                        <!-- Job Status -->
                        <div>
                            <div class="segmented-control">
                                <div id="optEmployed" class="segmented-option active" onclick="setEmployment('employed')">Angestellt</div>
                                <div id="optSelf" class="segmented-option" onclick="setEmployment('selfEmployed')">Selbstständig</div>
                            </div>
                        </div>

                        <!-- Income -->
                        <div>
                            <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Zu versteuerndes Einkommen</label>
                            <div class="ios-input-group">
                                <input type="number" id="income" value="60000" class="ios-input text-right font-bold text-lg" oninput="calculate()">
                                <span class="text-[#86868B] font-medium text-sm ml-2">€</span>
                            </div>
                        </div>

                        <!-- Existing GRV Input -->
                        <div id="grv-input-container" class="hidden transition-all duration-300">
                            <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Beitrag Gesetzl. Rente / VW</label>
                            <div class="ios-input-group">
                                <input type="number" id="existingGRV" value="0" class="ios-input text-right font-bold text-lg" oninput="calculate()">
                                <span class="text-[#86868B] font-medium text-sm ml-2">€</span>
                            </div>
                            <p class="text-[10px] text-[#86868B] ml-1 mt-1">Jahresbeitrag zur Basisabsicherung (falls vorhanden)</p>
                        </div>

                        <!-- Custom Dropdowns -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Status</label>
                                <div class="custom-select-container" id="dropdown-marital">
                                    <div class="custom-select-trigger">
                                        <span class="trigger-text">Ledig</span>
                                        <span class="material-symbols-rounded text-gray-400">expand_more</span>
                                    </div>
                                    <div class="custom-select-options">
                                        <div class="custom-option selected" data-value="single">Ledig</div>
                                        <div class="custom-option" data-value="married">Verheiratet</div>
                                    </div>
                                    <input type="hidden" id="maritalStatus" value="single">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Region</label>
                                <div class="custom-select-container" id="dropdown-state">
                                    <div class="custom-select-trigger">
                                        <span class="trigger-text">BW</span>
                                        <span class="material-symbols-rounded text-gray-400">expand_more</span>
                                    </div>
                                    <div class="custom-select-options">
                                        <div class="custom-option selected" data-value="BW">Baden-Würt.</div>
                                        <div class="custom-option" data-value="BY">Bayern</div>
                                        <div class="custom-option" data-value="BE">Berlin</div>
                                        <div class="custom-option" data-value="BB">Brandenburg</div>
                                        <div class="custom-option" data-value="HB">Bremen</div>
                                        <div class="custom-option" data-value="HH">Hamburg</div>
                                        <div class="custom-option" data-value="HE">Hessen</div>
                                        <div class="custom-option" data-value="MV">MV</div>
                                        <div class="custom-option" data-value="NI">Niedersachsen</div>
                                        <div class="custom-option" data-value="NW">NRW</div>
                                        <div class="custom-option" data-value="RP">RLP</div>
                                        <div class="custom-option" data-value="SL">Saarland</div>
                                        <div class="custom-option" data-value="SN">Sachsen</div>
                                        <div class="custom-option" data-value="ST">S.-Anhalt</div>
                                        <div class="custom-option" data-value="SH">SH</div>
                                        <div class="custom-option" data-value="TH">Thüringen</div>
                                    </div>
                                    <input type="hidden" id="state" value="BW">
                                </div>
                            </div>
                        </div>

                        <!-- Toggles with Apple Switches -->
                        <div class="bg-white rounded-2xl p-2 gap-2 flex flex-col border border-gray-100 shadow-sm transition-transform hover:scale-[1.01] duration-300">
                            <!-- GRV Toggle -->
                            <div id="grv-toggle-container" class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-xl transition-colors">
                                <span class="text-xs font-bold text-[#1D1D1F] ml-1">Gesetzliche Rente (Pflicht)</span>
                                <input type="checkbox" id="paysGRV" class="toggle-switch" checked disabled>
                            </div>
                            <div class="h-[1px] bg-gray-100 mx-3"></div>
                            <!-- Church Tax Toggle -->
                            <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-xl transition-colors">
                                <span class="text-xs font-bold text-[#1D1D1F] ml-1">Kirchensteuer</span>
                                <input type="checkbox" id="churchTax" class="toggle-switch" onchange="calculate()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Savings Card -->
                <div class="ios-card p-6 relative" style="z-index: 40;">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-full bg-green-50 text-[#34C759] flex items-center justify-center shadow-sm">
                            <span class="material-symbols-rounded text-xl">savings</span>
                        </div>
                        <h2 class="text-lg font-bold text-[#1D1D1F]">Investition</h2>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-end mb-3">
                                <label class="text-[11px] font-bold text-[#86868B] uppercase tracking-wider">Monatliche Rate</label>
                                <span id="savingsDisplay" class="text-3xl font-bold text-[#1D1D1F] tracking-tight">250 €</span>
                            </div>
                            <input type="range" id="savings" min="50" max="2500" step="10" value="250" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="calculate()">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Alter</label>
                                <div class="ios-input-group">
                                    <input type="number" id="currentAge" value="30" class="ios-input text-center font-bold text-lg" oninput="calculate()">
                                </div>
                            </div>
                            <div>
                                <label class="block text-[11px] font-bold text-[#86868B] uppercase mb-2 ml-1 tracking-wider">Rentenbeginn</label>
                                <div class="ios-input-group">
                                    <input type="number" id="retirementAge" value="67" class="ios-input text-center font-bold text-lg" oninput="calculate()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Strategy Card -->
                <div class="ios-card p-6 bg-gradient-to-br from-white to-[#F9F9F9] relative" style="z-index: 30;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold text-[#1D1D1F]">Anlagestrategie</h2>
                        <span class="text-[10px] font-bold bg-[#F2F2F7] px-2 py-1 rounded text-[#86868B]">MIX</span>
                    </div>
                    
                    <div class="relative mb-6">
                        <div class="flex justify-between text-[10px] font-bold text-[#86868B] uppercase tracking-widest mb-2">
                            <span>Sicherheit</span>
                            <span class="text-[#B8860B]">Chance</span>
                        </div>
                        <input type="range" id="riskSlider" min="0" max="100" value="100" class="accent-[#B8860B] w-full" oninput="calculate()">
                    </div>

                    <div class="flex gap-3 text-center">
                        <div class="flex-1 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                            <div class="text-[9px] text-[#86868B] uppercase font-bold mb-1">Garantie</div>
                            <div class="font-bold text-lg text-[#1D1D1F]" id="securePercent">0%</div>
                        </div>
                        <div class="flex-1 bg-white p-3 rounded-xl border border-yellow-100 shadow-sm">
                            <div class="text-[9px] text-[#B8860B] uppercase font-bold mb-1">Fonds/Gold</div>
                            <div class="font-bold text-lg text-[#B8860B]" id="riskPercent">100%</div>
                        </div>
                    </div>
                    <div class="text-center mt-4 bg-gray-50 rounded-lg p-2">
                        <span class="text-[11px] text-[#86868B] font-medium">Erwartete Rendite: <strong class="text-[#1D1D1F]" id="yieldDisplay">6.50%</strong> p.a.</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Results & Chart -->
            <div class="lg:col-span-8 space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="ios-card p-8 flex flex-col justify-between h-56 relative overflow-hidden group bg-white">
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-2.5 h-2.5 rounded-full bg-[#34C759] shadow-[0_0_10px_#34C759]"></div>
                                <span class="text-xs font-bold text-[#86868B] uppercase tracking-wider">Endkapital (Prognose)</span>
                            </div>
                            <h3 class="text-5xl font-bold text-[#1D1D1F] tracking-tight" id="totalCapital">0 €</h3>
                        </div>
                        <div class="relative z-10 mt-auto">
                            <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-green-50 border border-green-100 text-[#1D8F42] rounded-full text-xs font-bold shadow-sm">
                                <span class="material-symbols-rounded text-sm">verified</span>
                                <span>Nach allen Kosten</span>
                            </div>
                        </div>
                        <div class="absolute -right-12 -bottom-12 w-64 h-64 bg-gradient-to-br from-green-100/50 to-transparent rounded-full blur-3xl opacity-60 pointer-events-none"></div>
                    </div>
                    <div class="ios-card p-8 flex flex-col justify-between h-56 bg-[#1D1D1F] text-white relative overflow-hidden shadow-2xl border-0">
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-2.5 h-2.5 rounded-full bg-[#FFD60A] shadow-[0_0_10px_#FFD60A]"></div>
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Mögliche Rente</span>
                            </div>
                            <h3 class="text-5xl font-bold mt-1 tracking-tight text-white" id="monthlyPension">0 €</h3>
                        </div>
                        <div class="relative z-10 mt-auto border-t border-white/10 pt-4 flex justify-between items-center">
                            <div>
                                <span class="block text-[10px] text-gray-400 uppercase font-bold">Startet ab</span>
                                <span class="text-sm font-bold" id="pensionStartDisplay">Alter 67</span>
                            </div>
                            <span class="material-symbols-rounded text-yellow-400 text-3xl">stars</span>
                        </div>
                        <div class="absolute top-0 right-0 w-full h-full bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
                    </div>
                </div>

                <!-- Tax Info Bar -->
                <div class="ios-card p-8 bg-gradient-to-r from-white to-[#F9F9F9]">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-8">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 bg-white rounded-2xl shadow-md border border-gray-100 flex items-center justify-center text-[#0071E3]">
                                <span class="material-symbols-rounded text-3xl">account_balance</span>
                            </div>
                            <div>
                                <h4 class="text-xl font-bold text-[#1D1D1F]">Effektiver Aufwand</h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-xs font-semibold text-[#86868B]">Nach Steuererstattung</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold text-[#1D1D1F] tracking-tight" id="netMonthlyEffort">0 €</div>
                            <div class="inline-block mt-2 bg-green-100 text-[#1D8F42] px-3 py-1 rounded-lg text-xs font-bold">
                                Ersparnis: <span id="monthlyTaxSavings">0 €</span> / Monat
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t border-gray-200 grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-[10px] text-[#86868B] uppercase font-bold mb-1">Gesamte Steuerersparnis</div>
                            <div class="text-lg font-bold text-[#1D1D1F]" id="totalTaxSavings">0 €</div>
                        </div>
                        <div class="relative border-l border-gray-200">
                            <div class="text-[10px] text-[#86868B] uppercase font-bold mb-1">Förderquote</div>
                            <div class="text-lg font-bold text-[#0071E3]" id="subsidyRate">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Main Chart -->
                <div class="ios-card p-8 bg-white">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h3 class="text-xl font-bold text-[#1D1D1F]">Vermögensentwicklung</h3>
                            <p class="text-xs text-[#86868B] mt-1 font-medium">Dynamische Hochrechnung über die Laufzeit</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-[#34C759]"></span>
                                <span class="text-xs font-bold text-[#1D1D1F]">Kapital</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-gray-300"></span>
                                <span class="text-xs font-bold text-[#86868B]">Invest</span>
                            </div>
                        </div>
                    </div>
                    <div class="h-[320px] w-full">
                        <canvas id="wealthChart"></canvas>
                    </div>
                </div>

                <!-- DETAILS DROPDOWN -->
                <div class="ios-card overflow-hidden">
                    <details class="group">
                        <summary class="flex justify-between items-center p-6 cursor-pointer list-none hover:bg-gray-50 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="bg-gray-100 p-2 rounded-xl">
                                    <span class="material-symbols-rounded text-[#86868B] text-xl block">analytics</span>
                                </div>
                                <span class="text-sm font-bold text-[#1D1D1F]">Detaillierte Analyse & Kosten</span>
                            </div>
                            <span class="bg-[#F2F2F7] rounded-full p-2 transition-transform duration-300 group-open:rotate-180 text-[#1D1D1F]">
                                <span class="material-symbols-rounded text-lg block">expand_more</span>
                            </span>
                        </summary>
                        <div class="px-6 pb-8 bg-[#FAFAFA] border-t border-gray-100">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-6">
                                <div>
                                    <h4 class="text-[10px] font-bold text-[#86868B] uppercase tracking-wider mb-4 border-b border-gray-200 pb-2">Kostenstruktur</h4>
                                    <ul class="space-y-3">
                                        <li class="flex justify-between items-center text-xs p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <span class="text-[#1D1D1F] font-bold">Alpha (Abschluss)</span>
                                            <span class="text-gray-500 font-mono">2,50% d. Summe</span>
                                        </li>
                                        <li class="flex justify-between items-center text-xs p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <span class="text-[#1D1D1F] font-bold">Beta (Verwaltung)</span>
                                            <span class="text-gray-500 font-mono">~12,0% Beitrag</span>
                                        </li>
                                        <li class="flex justify-between items-center text-xs p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <span class="text-[#1D1D1F] font-bold">Gamma (Fonds)</span>
                                            <span class="text-gray-500 font-mono">~0,60% p.a.</span>
                                        </li>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="text-[10px] font-bold text-[#86868B] uppercase tracking-wider mb-4 border-b border-gray-200 pb-2">Optionen & Faktoren</h4>
                                    <ul class="space-y-3">
                                        <li class="flex justify-between items-center text-xs p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <span class="text-[#1D1D1F] font-bold">Rentenfaktor</span>
                                            <span class="text-gray-500 font-mono">~26,50 €</span>
                                        </li>
                                        <li class="flex justify-between items-center text-xs p-3 bg-white rounded-xl border border-gray-100 shadow-sm">
                                            <span class="text-[#1D1D1F] font-bold">Abruf (62)</span>
                                            <span class="font-bold text-[#0071E3] font-mono" id="pension62">--- €</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { Chart, registerables } from "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/+esm";

        // !!! ECHTE DATEN !!!
        const firebaseConfig = {
            apiKey: "AIzaSyDKvJxVpK49BsmjgG6C9deuuZ-1q-Q36fk",
            authDomain: "basisrente-app.firebaseapp.com",
            projectId: "basisrente-app",
            storageBucket: "basisrente-app.firebasestorage.app",
            messagingSenderId: "28252529082",
            appId: "1:28252529082:web:0425733a7442b4fa3efd83",
            measurementId: "G-MRML46L886"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        Chart.register(...registerables);
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#86868B';

        // 2026/2025 CONFIG & TAX LOGIC
        const CONFIG = {
            allowance: 12096, deductSingle: 28624, deductMarried: 57248, 
            bbgWest: 96600, grvRateTotal: 0.186, 
            costs: { alpha: 0.025, beta: 0.12, gamma: 0.006 }, 
            pensionFactor: 26.50
        };

        // --- AUTH LOGIC ---
        let isRegisterMode = false;
        let wealthChart = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-overlay').classList.add('hidden-overlay');
                document.getElementById('main-app').classList.add('active-app');
                document.getElementById('logoutBtn').style.display = 'flex';
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden-overlay');
                document.getElementById('main-app').classList.remove('active-app');
                document.getElementById('logoutBtn').style.display = 'none';
            }
        });

        document.getElementById('toggleAuthMode').addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            updateAuthUI();
        });

        function updateAuthUI() {
            const title = document.getElementById('authTitle');
            const subtitle = document.getElementById('authSubtitle');
            const btn = document.getElementById('authBtnLabel');
            const toggle = document.getElementById('toggleAuthMode');
            const nameField = document.getElementById('nameField');
            const phoneField = document.getElementById('phoneField');
            const consentField = document.getElementById('consentField');
            const forgotContainer = document.getElementById('forgotPasswordContainer');

            document.getElementById('errorMsg').classList.add('hidden'); 

            if (isRegisterMode) {
                title.innerText = "Konto erstellen";
                btn.innerText = "Jetzt registrieren";
                toggle.innerText = "Bereits registriert? Hier anmelden";
                nameField.classList.remove('hidden');
                phoneField.classList.remove('hidden');
                consentField.classList.remove('hidden');
                forgotContainer.style.display = "none";
                document.getElementById('regName').required = true;
                document.getElementById('regConsent').required = true;
            } else {
                title.innerText = "Willkommen zurück";
                btn.innerText = "Anmelden";
                toggle.innerText = "Noch kein Konto? Jetzt registrieren";
                nameField.classList.add('hidden');
                phoneField.classList.add('hidden');
                consentField.classList.add('hidden');
                forgotContainer.style.display = "block";
                document.getElementById('regName').required = false;
                document.getElementById('regConsent').required = false;
            }
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPass').value;
            const btn = document.querySelector('.auth-btn');
            const originalText = btn.innerText;
            const errorMsg = document.getElementById('errorMsg');
            
            btn.innerHTML = '<span class="material-symbols-rounded animate-spin">progress_activity</span>';
            errorMsg.classList.add('hidden');

            try {
                if (isRegisterMode) {
                    await createUserWithEmailAndPassword(auth, email, password);
                    const name = document.getElementById('regName').value;
                    const phone = document.getElementById('regPhone').value;
                    await sendToMake(name, email, phone);
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error(error);
                errorMsg.innerText = "Fehler: " + error.code;
                errorMsg.classList.remove('hidden');
                btn.innerText = originalText;
            }
        });

        document.getElementById('forgotPasswordBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            if(email) sendPasswordResetEmail(auth, email).then(() => alert("E-Mail gesendet!"));
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        async function sendToMake(name, email, phone) {
            try {
                await fetch('https://hook.eu1.make.com/1v5ibarysflq76rm6riy64knvok9dgd5', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, phone, date: new Date().toISOString() })
                });
            } catch (e) {}
        }

        // --- CALCULATOR ENGINE ---
        const fmt = (n) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);
        const getVal = (id) => document.getElementById(id).value;
        const setTxt = (id, txt) => document.getElementById(id).innerText = txt;

        window.setEmployment = function(status) {
            const empBtn = document.getElementById('optEmployed');
            const selfBtn = document.getElementById('optSelf');
            const grvInput = document.getElementById('grv-input-container');
            const grvToggle = document.getElementById('grv-toggle-container'); 

            if(status === 'employed') {
                empBtn.className = 'segmented-option active';
                selfBtn.className = 'segmented-option';
                grvInput.classList.add('hidden'); 
                grvToggle.classList.remove('hidden'); 
                document.getElementById('paysGRV').checked = true; 
            } else {
                empBtn.className = 'segmented-option';
                selfBtn.className = 'segmented-option active';
                grvInput.classList.remove('hidden'); 
                grvToggle.classList.add('hidden'); 
                document.getElementById('paysGRV').checked = false; 
            }
            calculate();
        };

        // UI Helpers
        function initCustomSelect(id) {
            const container = document.getElementById(id);
            const trigger = container.querySelector('.custom-select-trigger');
            const hiddenInput = container.querySelector('input[type="hidden"]');
            const triggerText = container.querySelector('.trigger-text');
            
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-select-container').forEach(c => c !== container && c.classList.remove('open'));
                container.classList.toggle('open');
            });
            container.querySelectorAll('.custom-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    hiddenInput.value = opt.dataset.value;
                    triggerText.innerText = opt.innerText;
                    container.querySelectorAll('.custom-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    container.classList.remove('open');
                    calculate();
                });
            });
            document.addEventListener('click', () => container.classList.remove('open'));
        }
        initCustomSelect('dropdown-marital');
        initCustomSelect('dropdown-state');

        function calculateIncomeTax(zvE) {
            if (zvE <= 12096) return 0;
            let tax = 0;
            const y = (zvE - 12096) / 10000;
            if (zvE <= 17469) { 
                tax = (974.58 * y + 1400) * y;
            } else if (zvE <= 68480) { 
                const z = (zvE - 17469) / 10000;
                tax = (208.85 * z + 2397) * z + 997.26; 
            } else if (zvE <= 277825) { 
                tax = 0.42 * zvE - 10636.57;
            } else { 
                tax = 0.45 * zvE - 18971.32;
            }
            return Math.floor(tax);
        }

        window.calculate = function() {
            const income = parseFloat(getVal('income')) || 0; 
            const savings = parseFloat(getVal('savings'));
            const age = parseFloat(getVal('currentAge'));
            const retireAge = parseFloat(getVal('retirementAge'));
            const risk = parseFloat(getVal('riskSlider')) / 100;
            const marital = getVal('maritalStatus'); 
            const isEmployed = document.getElementById('optEmployed').className.includes('active');
            const churchTaxOn = document.getElementById('churchTax').checked;
            const state = getVal('state');

            setTxt('savingsDisplay', fmt(savings));
            setTxt('riskPercent', Math.round(risk * 100) + '%');
            setTxt('securePercent', Math.round((1 - risk) * 100) + '%');
            setTxt('pensionStartDisplay', `Alter ${retireAge}`);
            
            const yieldRate = (0.02 * (1 - risk)) + (0.07 * risk);
            setTxt('yieldDisplay', (yieldRate * 100).toFixed(2) + '%');

            let taxBase = income;
            if (marital === 'married') taxBase = income / 2; 

            let baseTax = calculateIncomeTax(taxBase);
            if (marital === 'married') baseTax *= 2; 

            let maxDeductible = CONFIG.deductSingle;
            if (marital === 'married') maxDeductible = CONFIG.deductMarried;

            let existingGRV = 0;
            if (isEmployed) {
                const relevantIncome = Math.min(income, CONFIG.bbgWest); 
                existingGRV = relevantIncome * CONFIG.grvRateTotal; 
            } else {
                existingGRV = parseFloat(getVal('existingGRV')) || 0;
            }

            const remainingSpace = Math.max(0, maxDeductible - existingGRV);
            const annualSavings = savings * 12;
            const deductibleAmount = Math.min(annualSavings, remainingSpace);

            let newTaxBase = income - deductibleAmount;
            if (marital === 'married') newTaxBase = newTaxBase / 2;
            
            let newTax = calculateIncomeTax(newTaxBase);
            if (marital === 'married') newTax *= 2;

            const soliRate = 0.055;
            const churchRate = (state === 'BW' || state === 'BY') ? 0.08 : 0.09;

            let taxSavings = (baseTax - newTax); 
            if (baseTax > 18130) { taxSavings += (taxSavings * soliRate); }
            if (churchTaxOn) { taxSavings += (taxSavings * churchRate); }

            const monthlyTaxSavings = taxSavings / 12;
            const netEffort = savings - monthlyTaxSavings;
            const subsidy = (taxSavings / annualSavings) * 100;

            setTxt('netMonthlyEffort', fmt(netEffort));
            setTxt('monthlyTaxSavings', fmt(monthlyTaxSavings));
            setTxt('totalTaxSavings', fmt(taxSavings * (retireAge - age)));
            setTxt('subsidyRate', subsidy.toFixed(1) + '%');

            const duration = retireAge - age;
            const months = duration * 12;
            let capital = 0;
            let paid = 0;
            const totalSum = annualSavings * duration;
            const totalAlpha = totalSum * CONFIG.costs.alpha;
            const alphaMonthly = totalAlpha / 60; 

            const dataCap = [];
            const dataInv = [];
            const labels = [];

            if(duration > 0) {
                for(let i=1; i<=months; i++) {
                    paid += savings;
                    let invest = savings;
                    if(i <= 60) invest -= alphaMonthly; 
                    invest -= (savings * CONFIG.costs.beta); 
                    capital += invest;
                    capital = capital * (1 + yieldRate/12); 
                    capital -= (capital * CONFIG.costs.gamma/12); 

                    if(i % 12 === 0) {
                        dataCap.push(capital);
                        dataInv.push(paid);
                        labels.push(age + (i/12));
                    }
                }
            }

            const finalCapital = capital;
            const finalPension = (capital / 10000) * CONFIG.pensionFactor;

            setTxt('totalCapital', fmt(finalCapital));
            setTxt('monthlyPension', fmt(finalPension));
            setTxt('pension62', fmt(finalPension * 0.78));

            updateChart(labels, dataCap, dataInv);
        };

        function updateChart(lbls, cap, inv) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            if(wealthChart) wealthChart.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(52, 199, 89, 0.2)');
            gradient.addColorStop(1, 'rgba(52, 199, 89, 0)');

            wealthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: lbls,
                    datasets: [
                        { label: 'Kapital', data: cap, borderColor: '#34C759', backgroundColor: gradient, borderWidth: 3, fill: true, tension: 0.4, pointRadius: 0 },
                        { label: 'Einzahlung', data: inv, borderColor: '#C7C7CC', borderWidth: 2, borderDash: [6,6], fill: false, tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: { duration: 800, easing: 'easeOutQuart' },
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { border: { display: false }, grid: { color: '#F2F2F7' }, ticks: { font: { family: 'Inter' }, color: '#86868B', callback: v => (v/1000) + 'k' } } }
                }
            });
        }
        
        calculate();

    </script>
</body>
</html>